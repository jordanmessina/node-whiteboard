<html>
    <head>
        <script type="text/javascript" src="jquery-1.6.4.min.js"></script>
        <script type="text/javascript" src="socket.io.js"></script>
        <script type="text/javascript">
            function init(){
        
                var draw;
                var lastPoint;
                var canvas = setupCanvas();
                var canvasOffset = canvasOffset();
                var socket = io.connect('http://'+window.location.hostname+':8080');

               
                function initStroke() {
                    draw = false;
                    lastPoint = [-1, -1];
                }
                
                
                function setupCanvas()  {
                    var canvasElement = $('#drawing-area');
                    var canvas =  canvasElement.getContext("2d");
                    var oldWidth = canvasElement.width;
                    
                    canvasElement.width = 0;
                    canvasElement.width = oldWidth;
                    
                    canvas.strokeStyle = '#000000';
                    canvas.lineWidth = 5;
                    canvas.lineCap = 'round';
                    
                    initStroke();
                    
                    return canvas;
            
                }

                //why is this needed?
                function objectPosition(obj) {
                    var curleft = 0;
                      var curtop = 0;
                      if (obj.offsetParent) {
                            do {
                                  curleft += obj.offsetLeft;
                                  curtop += obj.offsetTop;
                            } while (obj = obj.offsetParent);
                      }
                      return [curleft,curtop];
                };
                
                function canvasOffset()
                {
                    return objectPosition($('#drawing-area'));
                }

                function drawStroke(point1, point2, from_socket){
                    canvas.beginPath();
                    canvas.moveTo(point1[0], point1[1]);
                    canvas.lineTo(point2[0], point2[1]);
                    canvas.stroke();
                    if(!from_socket){
                        socket.emit('draw-coords', {point1: point1, point2:point2});
                    }
                    return;
                };

                function clearCanvas(from_socket){
                    canvas = setupCanvas();
                    if(!from_socket){
                        socket.emit('clear', {});
                    }
                    return;
                };


                //attach events to the canvas
                $('#drawing-area').mouseup(function(){
                    initStroke();
                });
                $('#drawing-area').mouseleave(function(){
                    initStroke();
                });
                $('#drawing-area').mousedown(function(e){
                    /*
                        event to initialize drawing. Grab the x,y coords from the event
                        for point2 we add 1px to x so there is a diff between the points
                        allowing canvas to draw a line and the user sees a black dot on
                        first click
                    */
                    draw = true;
                    point1 = [e.pageX - canvasOffset[0], e.pageY - canvasOffset[1]];
                    point2 = [e.pageX - canvasOffset[0]+1, e.pageY - canvasOffset[1]];
                    lastPoint = point1;
                    drawStroke(point1, point2, false);
                });
                $('#drawing-area').mousemove(function(e){
                    /*
                        we use the last_point for point1 (set with mousedown event)
                        point2 is set from event e x,y coord
                        reset last_point to point2 after drawing
                    */
                    if(draw){
                        point1 = lastPoint; 
                        point2 = [e.pageX - canvasOffset[0], e.pageY - canvasOffset[1]];
                        drawStroke(point1, point2, false);
                        lastPoint = point2;
                    }
                });

                //make sure the offset is updated on a window resize
                $(window).resize(function(){
                    draw_area_offset = canvasOffset();    
                });

                //clear canvas when 'clear' button is clicked
                $('#clear-canvas').click(function(){
                    clearCanvas(false);
                });

                //websocket event, receive data which contains 2 points
                //data = {poin1: [x, y], point2: [x,y]}
                socket.on('draw', function(data){
                    point1 = [data['point1'][0], data['point1'][1]];
                    point2 = [data['point2'][0], data['point2'][1]];
                    drawStroke(point1, point2, true);
                });

                //websocket event to clear the 
                socket.on('clear', function(data){
                    clearCanvas(true);
                });

            }
        </script>
        <style type="text/css">
            #canvas-div { text-align: center;}
        </style>
    </head>
    <body onload="init();">
        <div id="canvas-div">
            <canvas id="drawing-area" width="1200" height="500" style="border: 1px; border-style: solid; cursor: crosshair;"></canvas>
        </div>
        <div style="text-align:center;">
            <button id="clear-canvas">Clear</button>
        </div>
        <div style="text-align:center;">
            <a href="mobile.html">iPhone/iPad/Android Version</a>
        </div>
    </body>
</html>
